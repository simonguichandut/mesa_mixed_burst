! Relax outer boundary to tau=1

&star_job

  saved_model_name = 'models/ns_env_Edd.mod'
  save_model_filename = 'models/ns_env_tau1.mod'
  
  relax_initial_tau_factor = .true.
  relax_tau_factor = .true.
  relax_to_this_tau_factor = 1.0
  dlogtau_factor = 0.01

  !! necessary to have a small initial dt for this relax to work 
  !! (which then sets max_dt for the rest of relax)
  set_initial_dt = .true.
  seconds_for_initial_dt = 1d-10

  !! If hydrodynamics were not on already, they need to now for the outer B.C.
  change_v_flag = .true. 
  change_initial_v_flag = .true. 
  new_v_flag = .true.

  pgstar_flag = .true.

  !! Run-specific inlist
  read_extra_star_job_inlist2 = .true.
  extra_star_job_inlist2_name = 'inlist_folder/inlist3_relax_tau_extra'

/ ! end of star_job namelist

&controls

  !! End after relax
  max_model_number = 1
        
  !! turn off convection
  MLT_option = 'none'
  use_Ledoux_criterion = .false.  

  !! Turn off nuclear reactions (appears to be necessary for this relax step to work properly)
  max_abar_for_burning = -1
  
  !! Atmosphere
  atm_option = 'T_tau'
  atm_T_tau_relation = 'Eddington'
  atm_T_tau_opacity = 'fixed'
  Pextra_factor = 2

  !! Outer BC from YW18 (in turn from Quataert+2016)
  use_compression_outer_BC = .true.
  use_zero_dLdm_outer_BC = .true.

  !! Energy conservation
  ! Seems like the first one is necessary to avoid a temperature spike at the inner boundary
  always_use_dedt_form_of_energy_eqn = .false.
  ! always_use_eps_grav_form_of_energy_eqn = .true.

  !! Temperature gradient form
  ! This is more appropriate for non-hydrostatic situations
  ! https://docs.mesastar.org/en/release-r21.12.1/reference/controls.html?highlight=use_dPrad_dm_form_of_T_gradient_eqn#use-gradt-actual-vs-gradt-mlt-for-t-gradient-eqn
  use_dPrad_dm_form_of_T_gradient_eqn = .true.

  !! Resolution
  varcontrol_target = 0.5d-3
  mesh_delta_coeff = 0.5
  time_delta_coeff = 1.0

  min_timestep_limit = 1d-20
  max_allowed_nz = 20000 ! default 8k

  merge_if_dlnR_too_small = .true.
  mesh_min_dlnR = 1d-9

  !! Files 
  photo_interval = 1000
  profile_interval = 1000

  !! Run-specific inlist
  read_extra_controls_inlist2 = .true.
  extra_controls_inlist2_name = 'inlist_folder/inlist3_relax_tau_extra'

/ ! end of controls namelist
