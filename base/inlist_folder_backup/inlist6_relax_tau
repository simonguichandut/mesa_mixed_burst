! relax the atmosphere to photosphere (tau=1)

&star_job

   show_log_description_at_start = .false. 
   
   load_saved_model = .true.
   saved_model_name = 'models/ns_env_Edd.mod'

   save_model_when_terminate = .true.
   save_model_filename = 'models/ns_env_tau1.mod'
   save_pgstar_files_when_terminate = .true.
   
   relax_initial_tau_factor = .true.
   relax_tau_factor = .true.
   relax_to_this_tau_factor = 1.0
   dlogtau_factor = 0.01

   ! necessary to have a small initial dt for this relax to work (which then sets max_dt for the rest of relax, I think)
   set_initial_dt = .true.
   seconds_for_initial_dt = 1d-7 ! there is a difference between 1d-4 and 1d-7, compare runs A&B

  ! If hydrodynamics were not on already, they need to now for the outer B.C.
  change_v_flag = .true. 
  change_initial_v_flag = .true. 
  new_v_flag = .true.

   pgstar_flag = .true.

/ ! end of star_job namelist

&controls

   ! end after relax
   max_model_number = 1
         
   ! turn off convection
   MLT_option = 'none'
   use_Ledoux_criterion = .false.  

   ! turn off nuclear reactions (appears to be necessary for this relax step to work properly)
   max_abar_for_burning = -1
   
   ! Atmosphere
   atm_option = 'T_tau'
   atm_T_tau_relation = 'Eddington'
   !atm_T_tau_opacity = 'varying'      
   ! atm_T_tau_opacity = 'iterated'
   atm_T_tau_opacity = 'fixed'
   Pextra_factor = 2
   ! Pextra_factor = 3

   ! Outer BC from YW18 (in turn from Quataert+2016)
   use_compression_outer_BC = .true.
   use_zero_dLdm_outer_BC = .true.

   ! Energy conservation
   ! Seems like the first one is necessary to avoid a temperature spike at the inner boundary ..?
   ! weird because no_dedt_form_during_relax defaults to true
   always_use_dedt_form_of_energy_eqn = .false.
   ! always_use_eps_grav_form_of_energy_eqn = .true.

   ! Temperature gradient form
   ! This is more appropriate for non-hydrostatic situations?
   ! https://docs.mesastar.org/en/release-r21.12.1/reference/controls.html?highlight=use_dPrad_dm_form_of_T_gradient_eqn#use-gradt-actual-vs-gradt-mlt-for-t-gradient-eqn
   use_dPrad_dm_form_of_T_gradient_eqn = .true.

   ! Resolution
   time_delta_coeff = 1.0
   mesh_delta_coeff = 0.5
   varcontrol_target = 0.5d-3

   min_timestep_limit = 1d-20
   max_allowed_nz = 20000 ! default 8k

   merge_if_dlnR_too_small = .true.
   mesh_min_dlnR = 1d-9

   ! output
   photo_interval = 1000
   profile_interval = 1000
   history_interval = 1000
   terminal_interval = 1
   write_header_frequency = 10
   terminal_show_age_units = 'seconds'
   write_controls_info_with_profile = .true.



   !! dont make a difference (at least for this relax step)
   ! use_avQ_art_visc = .true.
   ! dt_div_min_dr_div_cs_limit = 1e10
   ! dt_div_min_dr_div_cs_hard_limit = 1e10
   ! max_abs_rel_run_E_err = 1d9   
   ! min_dq = 1d-12
   ! max_center_cell_dq = 5e-6
   ! max_surface_cell_dq = 1d-10
   ! limit_for_rel_error_in_energy_conservation = 1d-4
   ! hard_limit_for_rel_error_in_energy_conservation = 1d-3
   ! tol_correction_norm = 1d-5 !3d-5
   ! tol_max_correction = 1d-3 !6d-3
   ! iter_for_resid_tol2 = 4
   ! tol_residual_norm1 = 1d-8
   ! tol_max_residual1 = 1d-7
   ! fe_core_infall_limit = 1d99
   ! tiny_corr_coeff_limit = 999999
   ! solver_itermin_until_reduce_min_corr_coeff = 999999
   ! hydro_mtx_min_allowed_logRho = -1d99


/ ! end of controls namelist
