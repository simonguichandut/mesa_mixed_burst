! Fall back of the atmosphere after the Eddington phase
! Start by removing the innermost point with acceleration=0

&star_job

   show_log_description_at_start = .false. 
   
   load_saved_model = .true.
   saved_model_name = 'models/ns_env_ejected.mod'
   
   save_model_when_terminate = .true.
   save_model_filename = 'models/final.mod'
   save_pgstar_files_when_terminate = .true.

   change_initial_v_flag = .true.
   new_v_flag = .true.

   set_initial_age = .true.
   set_initial_model_number = .true.

   remove_initial_surface_at_cell_k = 674

   ! remove_surface_by_density = 1d-10
   ! remove_surface_by_density = 1d-8
   ! repeat_remove_surface_for_each_step = .true.

   set_initial_dt = .true.
   seconds_for_initial_dt = 1d-10

   pgstar_flag = .true.

/ ! end of star_job namelist

&controls

   !! Analytic electron scattering opacity from Paczynski
   use_other_kap = .true.        !$
   x_logical_ctrl(3) = .false.   !$

   max_age_in_seconds = 60d0
   max_model_number = 1000
   ! max_model_number = 250
   max_timestep = 1d0
         
   !! turn off convection
   MLT_option = 'none'
   ! mixing_length_alpha = 1.5
   ! MLT_option = 'Henyey'
   ! use_Ledoux_criterion = .false.  

   ! mixing needed?
!    use_Ledoux_criterion = .true.  
!   alpha_semiconvection = 0.1
!   thermohaline_coeff = 2
!   thermohaline_option = 'Kippenhahn'

   !! net on or off
   max_abar_for_burning = -1
   
   !! Atmosphere option
   atm_option = 'T_tau'
   atm_T_tau_relation = 'Eddington'
   !atm_T_tau_opacity = 'varying'      
   ! atm_T_tau_opacity = 'iterated'
   atm_T_tau_opacity = 'fixed'
   ! Pextra_factor = 2
   ! Pextra_factor = 3


   !! resolution
   mesh_delta_coeff = 0.5
   varcontrol_target = 0.5d-3
   ! time_delta_coeff = 1.0
   time_delta_coeff = 0.5
   min_timestep_limit = 1d-20
   max_allowed_nz = 20000 ! default 8k

   merge_if_dlnR_too_small = .true.
   mesh_min_dlnR = 1d-9

   !! timestep controls
   ! delta_lgRho_limit = 0.5


   !! Energy conservation
   ! use_gold_tolerances = .false.  ! default true                !x
   ! use_gold2_tolerances = .false. ! default true                !x
   ! convergence_ignore_equL_residuals = .true. ! default false   !x

   ! wind only develops if energy_eqn = eps_grav. Otherwise outer grid cell just cools down forever while staying at the same density
   always_use_dedt_form_of_energy_eqn = .false.    !$
   always_use_eps_grav_form_of_energy_eqn = .true. !$
      
   !! Temperature gradient form
   ! This is more appropriate for non-hydrostatic situations?
   ! https://docs.mesastar.org/en/release-r21.12.1/reference/controls.html?highlight=use_dPrad_dm_form_of_T_gradient_eqn#use-gradt-actual-vs-gradt-mlt-for-t-gradient-eqn
   use_dPrad_dm_form_of_T_gradient_eqn = .true.


   !! Outer BC from YW18 (in turn from Quataert+2016)
   use_compression_outer_BC = .true.
   use_zero_dLdm_outer_BC = .true.


   !! output
   photo_interval = 100
   profile_interval = 5
   history_interval = 1000
   terminal_interval = 5
   write_header_frequency = 20
   terminal_show_age_units='seconds'
   ! write_controls_info_with_profile = .true.


   !! ?
   ! dt_div_min_dr_div_cs_limit = 1e10
   ! dt_div_min_dr_div_cs_hard_limit = 1e10


   !! debugging
   ! report_why_dt_limits = .true.
   ! report_all_dt_limits = .false.

   ! report_solver_progress = .true.
   ! report_ierr = .true.
   ! show_mesh_changes = .true.
   
   hydro_mtx_max_allowed_logRho = 10d0
   hydro_mtx_max_allowed_logT = 9.5d0



   ! YW18
   ! Dutch_scaling_factor = 0.0 
   ! Dutch_wind_lowT_scheme = ‘de Jager’  ! why?
   ! Hot_wind_scheme = ‘Dutch’ 
   ! which_atm_option = ‘grey_and_kap’  ! equivalent to T-tau,Eddington,iterated
   ! Pextra_factor = 3                  ! default 1
   ! use_compression_outer_BC = .true. 
   ! use_zero_dLdm_outer_BC = .true. 
   ! shock_spread_linear = 0.0 
   ! shock_spread_quadratic = 1d-2 
   ! use_ODE_var_eqn_pairing = .true. 
   ! use_dPrad_dm_form_of_T_gradient_eqn = .true. 
   ! use_dvdt_form_of_momentum_eqn = .true. 
   ! use_ODE_form_of_density_eqn = .true. 
   ! okay_to_remesh = .true. 
   ! min_dq = 1d-12 
   ! max_center_cell_dq = 5e-6 
   ! max_allowed_nz = 14000 
   ! max_surface_cell_dq = 1d-12 
   ! P_function_weight = 40 
   ! log_tau_function_weight = 22 
   ! log_kap_function_weight = 20 
   ! logQ_min_limit = -18d0              ! gone https://docs.mesastar.org/en/release-r21.12.1/changelog.html?highlight=logq_min_limit#removal-of-logq-limits
   ! newton_iterations_limit = 7 
   ! iter_for_resid_tol2 = 4 
   ! tol_residual_norm1 = 1d-8 
   ! tol_max_residual1 = 1d-7 
   ! fe_core_infall_limit = 1d99 
   ! tiny_corr_coeff_limit = 999999 
   ! newton_itermin_until_reduce_min_corr_coeff = 999999
  

/ ! end of controls namelist
